import Head from "next/head";
import Row from "../components/Row";
import Banner from "../components/Banner";
import Header from "../components/Header";
import { getSession, useSession } from "next-auth/client";
import Login from "../components/Login";
import requests from "../requests";

export default function Home({
  trending,
  action,
  netflix,
  topRated,
  horror,
  comedy,
  romance,
  documentary,
}) {
  const session = useSession();
  if (!session[0]?.user) {
    return <Login />;
  }

  return (
    <div className="">
      <Head>
        <title>Create Next App</title>
        <link
          href="https://fonts.googleapis.com/css2?family=Inter"
          rel="stylesheet"
        />
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <Header user={session?.user} />
      <Banner movies={netflix.results} />

      {/* movies */}
      <div className="">
        <Row title="Trending" movies={trending.results} big={true} />
        <Row title="Action movies" movies={action.results} />
        <Row title="Top rated" movies={topRated.results} />
        <Row title="Horror " movies={horror.results} />
        <Row title="Comedy" movies={comedy.results} />
        <Row title="Romance" movies={romance.results} />
        <Row title="Documentaries" movies={documentary.results} />
      </div>
    </div>
  );
}

export async function getServerSideProps(context) {
  const session = await getSession(context);

  const [
    trendingRes,
    actionRes,
    netflixRes,
    topRatedRes,
    horrorRes,
    comedyRes,
    romanceRes,
    documentaryRes,
  ] = await Promise.all([
    fetch(`https://api.themoviedb.org/3${requests.fetchTrending}`),
    fetch(`https://api.themoviedb.org/3${requests.fetchActionMovies}`),
    fetch(`https://api.themoviedb.org/3${requests.fetchNetflixOriginals}`),
    fetch(`https://api.themoviedb.org/3${requests.fetchTopRated}`),
    fetch(`https://api.themoviedb.org/3${requests.fetchHorrorMovies}`),
    fetch(`https://api.themoviedb.org/3${requests.fetchComedyMovies}`),
    fetch(`https://api.themoviedb.org/3${requests.fetchRomanceMovies}`),
    fetch(`https://api.themoviedb.org/3${requests.fetchDocumentaries}`),
  ]);
  const [
    trending,
    action,
    netflix,
    topRated,
    horror,
    comedy,
    romance,
    documentary,
  ] = await Promise.all([
    trendingRes.json(),
    actionRes.json(),
    netflixRes.json(),
    topRatedRes.json(),
    horrorRes.json(),
    comedyRes.json(),
    romanceRes.json(),
    documentaryRes.json(),
  ]);
  return {
    props: {
      trending,
      action,
      netflix,
      topRated,
      horror,
      comedy,
      romance,
      documentary,
      session,
    },
  };
}
